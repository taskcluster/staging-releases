---
loader: taskgraph.loader.transform:loader

transforms:
  - src.transforms:add_task_env
  - src.transforms:parameterize_mounts
  - taskgraph.transforms.job:transforms
  - taskgraph.transforms.task:transforms

task-defaults:
  run:
    using: bare
  worker:
    max-run-time: 3600

tasks:
  decision-task:
    description: 'decision task for generic-worker tasks'
    worker-type: gw-ci-ubuntu-22-04
    scopes:
      - generic-worker:cache:generic-worker-checkout
      - secrets:get:project/taskcluster/testing/generic-worker/ci-creds
      - queue:scheduler-id:taskcluster-level-1
      - queue:create-task:highest:proj-taskcluster/gw-ci-*
      - queue:route:checks
    worker:
      taskcluster-proxy: true
      mounts:
        - content:
            url: 'https://storage.googleapis.com/golang/{go_version}.linux-amd64.tar.gz'
          directory: '{go_version}'
          format: tar.gz
    run:
      clone: false
      command:
        - export CGO_ENABLED=0
        - export GOROOT="$(pwd)/$GO_VERSION/go"
        - export PATH="${{GOPATH}}/bin:${{GOROOT}}/bin:${{PATH}}"
        - go version
        - go env
        - if [ ! -d taskcluster/.git ]; then
        -   rm -rf taskcluster
        -   git clone {head_repository} taskcluster
        - fi
        - cd taskcluster
        - git fetch "{head_repository}" "+${{GITHUB_SHA}}:refs/heads/X${{TASK_ID}}"
        - git checkout -f "X${{TASK_ID}}"
        - git reset --hard "${{GITHUB_SHA}}"
        - git clean -fdx
        - git checkout -B tmp -t "X${{TASK_ID}}"
        - cd workers/generic-worker/gw-decision-task
        - go install
        - '"$(go env GOPATH)/bin/gw-decision-task" tasks.yml "${{GITHUB_SHA}}"'
